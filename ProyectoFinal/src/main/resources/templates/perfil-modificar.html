<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Actualizar Usuario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
      integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <link rel="stylesheet" th:href="@{/css/custom.css}" />

    <link
      rel="shortcut icon"
      sizes="76x76"
      type="image/x-icon"
      th:href="@{images/logoInmobiliaria2.png}"
    />
  </head>
  <body id="body-registro-user" class="background_img">
    <!-- This is to display the Navbar of the website. -->
    <nav th:replace="fragments/navbar :: nav"></nav>

    <!-- End of NavBar -->

    <div class="container">
      <br />

      <form
        class="formulario"
        th:action="@{/usuario/modificar/__${session.usuariosession.idCodigoTributario}__}"
        method="POST"
      >
        <input
          hidden
          name="idCodigoTributario"
          th:value="${idCodigoTributario}"
        />
        <br />

        <div
          th:if="${error != null}"
          class="card text-white bg-danger mb-3 mensajeError"
        >
          <div class="card-body">
            <h5 class="card-title">Error ð</h5>
            <p class="card-text" th:text="${error}"></p>
          </div>
        </div>
        <div
          th:if="${exito != null}"
          class="card text-white bg-success mb-3 mt-3 mensajeExito"
        >
          <div class="card-body">
            <h5 class="card-title">Exito!</h5>
            <p class="card-text" th:text="${exito}"></p>
          </div>
        </div>
        <br />
        <h1><span class="badge badge-primary">Actualiza tu Perfil</span></h1>
        <br />
        <div class="form-row align-items-center">
          <div class="col-auto my-1">
            <label class="mr-sm-2 sr-only" for="inlineFormCustomSelect"
              >Preference</label
            >
            <select
              name="tipoPersona"
              class="custom-select mr-sm-2"
              id="inlineFormCustomSelect"
              th:field="${usuario.tipoPersona}"
              required
            >
              <option value="" selected disabled hidden>Tipo Persona...</option>
              <option value="1">Persona Humana</option>
              <option value="2">Persona Jurídica</option>
            </select>
          </div>
        </div>
        <br />
        <div class="form-group col-md-12">
          <div class="form-group col-md-6">
            <label class="col-form-label" for="exampleFormControlInput1"
              >Dirección</label
            >
            <input
              name="direccion"
              type="address"
              class="form-control"
              id="exampleFormControlInput1"
              placeholder="Av. Siempre Viva 2223"
              th:value="${usuario.direccion}"
              required
            />
          </div>

          <div class="form-row">
            <label class="col-form-label">Provincia</label>
            <select
              class="custom-select mr-sm-2"
              name="provincia"
              id="selectProvincias"
              required
            >
              <option value="Elige una provincia" selected disabled hidden>
                Elige una provincia
              </option>
            </select>

            <label class="col-form-label">Ciudad</label>
            <select
              name="ciudad"
              class="custom-select mr-sm-2"
              id="selectMunicipios"
              required
            >
              <option value="Elige un municipio" selected disabled hidden>
                Elige un municipio
              </option>
            </select>
          </div>

          <br />
          <div class="form-row align-items-center">
            <div class="col-auto my-1">
              <label class="mr-sm-2 sr-only" for="inlineFormCustomSelect"
                >Preference</label
              >
              <select
                name="sexo"
                class="custom-select mr-sm-2"
                id="inlineFormCustomSelect"
                th:field="${usuario.sexo}"
              >
                <option value="" selected disabled hidden>Sexo...</option>
                <option value="1">Femenino</option>
                <option value="2">Masculino</option>
                <option value="3">Otro</option>
              </select>
            </div>
          </div>
          <br />
          <br />
          <div class="form-group col-md-6">
            <label class="col-form-label" for="formGroupExampleInput"
              >Ingrese su número de celular</label
            >
            <input
              name="celular"
              type="text"
              class="form-control"
              id="formGroupExampleInput"
              placeholder="+54 11 1111 1111"
              th:value="${usuario.celular}"
              required
            />
          </div>
          <br />

          <div class="form-group col-md-6">
            <label class="col-form-label" for="exampleInputEmail1"
              >Dirección de correo electrónico</label
            >
            <input
              name="email"
              type="String"
              class="form-control"
              id="InputEmail1"
              th:value="${usuario.email}"
              required
            />
            <small id="emailHelp" class="form-text text-muted"
              >Nunca compartiremos con nadie su datos personales.</small
            >
          </div>
          <div class="form-group col-md-5">
            <label class="col-form-label" for="inputState">Cambio de Rol</label>
            <br />
            <select
                    name="Rol"
                    id="Rol"
                    th:field="${usuario.Rol}"
            >
              <option value="CLIENTE">CLIENTE</option>
              <option value="ENTE">ENTE</option>
              <option disabled="true" selected="true" value="">
                Seleccionar un Rol
              </option>
            </select>
          </div>
          <br />
          <br />
          <button type="submit" class="btn btn-primary col-md-7">
            Actualizar Datos
          </button>
        </div>
      </form>
    </div>

    <br />
    <hr />
    <form th:action="@{/eliminar-usuario}" method="post">
      <input
        style="visibility: hidden"
        th:value="${usuario.idCodigoTributario}"
        id="codigoTributario"
        name="codigoTributario"
        required
      />
      <button type="submit">Eliminar mi cuenta</button>
    </form>
    <div th:replace="fragments/footer :: footer"></div>
    <script>
      const $d = document;
      const $selectProvincias = $d.getElementById("selectProvincias");
      const $selectMunicipios = $d.getElementById("selectMunicipios");

      function provincia() {
        fetch("https://apis.datos.gob.ar/georef/api/provincias")
          .then((res) => (res.ok ? res.json() : Promise.reject(res)))
          .then((json) => {
            let $options = `<option value="Elige una provincia">Elige una provincia</option>`;

            json.provincias.forEach(
              (el) =>
                ($options += `<option value="${el.nombre}">${el.nombre}</option>`)
            );

            $selectProvincias.innerHTML = $options;
          })
          .catch((error) => {
            let message = error.statusText || "Ocurrió un error";

            $selectProvincias.nextElementSibling.innerHTML = `Error: ${error.status}: ${message}`;
          });
      }

      $d.addEventListener("DOMContentLoaded", provincia);

      function municipio(provincia) {
        fetch(
          `https://apis.datos.gob.ar/georef/api/municipios?provincia=${provincia}&max=100`
        )
          .then((res) => (res.ok ? res.json() : Promise.reject(res)))
          .then((json) => {
            let $options = `<option value="Elige un municipio">Elige un municipio</option>`;

            json.municipios.forEach(
              (el) =>
                ($options += `<option value="${el.id}">${el.nombre}</option>`)
            );

            $selectMunicipios.innerHTML = $options;
          })
          .catch((error) => {
            let message = error.statusText || "Ocurrió un error";

            $selectMunicipios.nextElementSibling.innerHTML = `Error: ${error.status}: ${message}`;
          });
      }

      $selectProvincias.addEventListener("change", (e) => {
        municipio(e.target.value);
        console.log(e.target.value);
      });

      function validarForm() {
        "use strict";

        var forms = document.querySelectorAll(".needs-validation");

        Array.prototype.slice.call(forms).forEach(function (form) {
          form.addEventListener(
            "submit",
            function (event) {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add("was-validated");
            },
            false
          );
        });
      }
    </script>
  </body>
</html>
